<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Workneed.workneed.Meetingroom.mapper.MeetingRoomMapper">

    <!-- ===============================
         예약 DTO 매핑
    =============================== -->
    <resultMap id="ReservationMap"
               type="com.Workneed.workneed.Meetingroom.dto.MeetingReservationDTO">

        <id property="reservationId" column="reservation_id"/>
        <result property="roomId" column="room_id"/>
        <result property="scheduleId" column="schedule_id"/>
        <result property="reserverId" column="reserver_id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="startAt" column="start_at"/>
        <result property="endAt" column="end_at"/>
    </resultMap>

    <!-- ===============================
         회의실 현황 매핑
    =============================== -->
    <resultMap id="RoomStatusMap"
               type="com.Workneed.workneed.Meetingroom.dto.MeetingRoomStatusDTO">

        <id property="roomId" column="room_id"/>
        <result property="roomName" column="room_name"/>

        <!-- ⭐ 핵심: 회의실 하나에 여러 예약 -->
        <collection property="reservations"
                    ofType="com.Workneed.workneed.Meetingroom.dto.MeetingReservationDTO"
                    resultMap="ReservationMap"/>
    </resultMap>

    <!-- ===============================
         회의실 현황 조회
         (근무시간과 겹치는 예약만)
    =============================== -->
    <select id="findMeetingRoomStatus" resultMap="RoomStatusMap">
        SELECT
            mr.room_id,
            mr.room_name,

            r.reservation_id,
            r.room_id       AS room_id,
            r.schedule_id,
            r.reserver_id,
            r.title,
            r.description,
            r.start_at,
            r.end_at
        FROM meeting_room mr
                 LEFT JOIN meeting_reservation r
                           ON mr.room_id = r.room_id
                               AND r.status = 'RESERVED'
                               AND r.start_at &lt; #{endAt}
                               AND r.end_at   &gt; #{startAt}
        WHERE mr.is_active = 'Y'
        ORDER BY mr.room_id, r.start_at
    </select>

    <!-- ===============================
         예약 중복 체크
    =============================== -->
    <select id="countConflict" resultType="int">
        SELECT COUNT(*)
        FROM meeting_reservation
        WHERE room_id = #{roomId}
          AND status = 'RESERVED'
          AND start_at &lt; #{endAt}
          AND end_at   &gt; #{startAt}
    </select>

    <!-- ===============================
         예약 저장
    =============================== -->
    <insert id="insertReservation" parameterType="com.Workneed.workneed.Meetingroom.dto.MeetingReservationDTO">
        INSERT INTO MEETING_RESERVATION (
            room_id,
            schedule_id, reserver_id,
            title,
            description,
            start_at,
            end_at
        ) VALUES (
                     #{roomId},
                     #{scheduleId}, #{reserverId},
                     #{title},
                     #{description},
                     #{startAt},
                     #{endAt}
                 )
    </insert>

</mapper>
