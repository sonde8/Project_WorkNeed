<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Workneed.workneed.Meetingroom.mapper.MeetingRoomMapper">

    <resultMap id="ReservationMap"
               type="com.Workneed.workneed.Meetingroom.dto.MeetingReservationDTO">
        <id property="reservationId" column="reservation_id"/>
        <result property="roomId" column="room_id"/>
        <result property="scheduleId" column="schedule_id"/>
        <result property="reserverId" column="reserver_id"/>
        <result property="startAt" column="start_at"/>
        <result property="endAt" column="end_at"/>
    </resultMap>

    <resultMap id="RoomStatusMap"
               type="com.Workneed.workneed.Meetingroom.dto.MeetingRoomStatusDTO">
        <id property="roomId" column="room_id"/>
        <result property="roomName" column="room_name"/>
        <result property="imagePath" column="image_path"/>
        <collection property="reservations"
                    ofType="com.Workneed.workneed.Meetingroom.dto.MeetingReservationDTO"
                    resultMap="ReservationMap"/>
    </resultMap>

    <select id="findMeetingRoomStatus" resultMap="RoomStatusMap">
        SELECT
            mr.room_id,
            mr.room_name,
            mr.image_path,  r.reservation_id,
            r.room_id       AS res_room_id,
            r.schedule_id,
            r.reserver_id,
            r.start_at,
            r.end_at
        FROM meeting_room mr
                 LEFT JOIN meeting_reservation r
                           ON mr.room_id = r.room_id
                               AND r.start_at &lt; #{endAt}
                               AND r.end_at   &gt; #{startAt}
        WHERE mr.is_active = 'Y'
        ORDER BY mr.room_id, r.start_at
    </select>

    <select id="countConflict" resultType="int">
        SELECT COUNT(*)
        FROM meeting_reservation
        WHERE room_id = #{roomId}
          AND start_at &lt; #{endAt}
          AND end_at   &gt; #{startAt}
    </select>

    <insert id="insertReservation" parameterType="com.Workneed.workneed.Meetingroom.dto.MeetingReservationDTO">
        INSERT INTO meeting_reservation (
            room_id,
            schedule_id,
            reserver_id,
            start_at,
            end_at
        ) VALUES (
                     #{roomId},
                     #{scheduleId},
                     #{reserverId},
                     #{startAt},
                     #{endAt}
                 )
    </insert>

    <delete id="deleteReservation">
        DELETE FROM meeting_reservation
        WHERE reservation_id = #{reservationId}
    </delete>

    <!-- ===============================
     일정(schedule)로 회의실 이름 조회
=============================== -->
    <select id="selectRoomNameByScheduleId" parameterType="long" resultType="string">
        SELECT mr.room_name
        FROM meeting_reservation r
                 JOIN meeting_room mr ON mr.room_id = r.room_id
        WHERE r.schedule_id = #{scheduleId}
        ORDER BY r.reservation_id DESC
            LIMIT 1
    </select>

    <!-- ===============================
     일정 삭제 시 예약 먼저 삭제
=============================== -->
    <delete id="deleteReservationsByScheduleIds">
        DELETE FROM meeting_reservation
        WHERE schedule_id IN
        <foreach collection="scheduleIds" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>

    <select id="countScheduleConflict" resultType="int">
        SELECT COUNT(*)
        FROM meeting_reservation
        WHERE schedule_id = #{scheduleId}
          AND start_at &lt; #{endAt}
          AND end_at   &gt; #{startAt}
    </select>


</mapper>