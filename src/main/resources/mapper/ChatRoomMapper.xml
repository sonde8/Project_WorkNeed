<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Workneed.workneed.Chat.mapper.ChatRoomMapper">
    <resultMap id="ChatRoomResultMap" type="com.Workneed.workneed.Chat.dto.ChatRoomDTO">
        <id property="roomId" column="room_id"></id>
        <result property="roomName" column="room_name"></result>
        <result property="roomType" column="room_type"/>
        <result property="creatorId" column="creator_id"/>
        <result property="createdAt" column="created_at"/>

        <result property="lastMessageContent" column="last_message_content"/>
        <result property="lastMessageTime" column="last_message_time"/>
        <result property="lastMessageType" column="last_message_type"/>
        <result property="userCount" column="user_count"/>
        <result property="unreadCount" column="unread_count"></result>
    </resultMap>

    <insert id="createChatRoom" parameterType="ChatRoomDTO" useGeneratedKeys="true" keyProperty="roomId">
        INSERT INTO chatroom (room_name, room_type, creator_id)
        VALUES (#{roomName}, #{roomType}, #{creatorId})
    </insert>

    <select id="findAllRoomsByUserId" parameterType="Long" resultMap="ChatRoomResultMap">
        SELECT
            cr.room_id,
            cr.room_name,
            cr.room_type,
            cr.creator_id,
            cr.created_at,

            -- 방 이름을 설정하지 않을 때 참여자들의 이름을 조합하는 쿼리 (User -> user)
            CASE
                WHEN cr.room_name IS NOT NULL AND cr.room_name != '' THEN cr.room_name
                ELSE (
                    SELECT
                        CASE
                            WHEN COUNT(*) > 3 THEN CONCAT(GROUP_CONCAT(u.user_name ORDER BY u.user_name ASC SEPARATOR ', '), '...')
                            ELSE GROUP_CONCAT(u.user_name ORDER BY u.user_name ASC SEPARATOR ', ')
                            END
                    FROM roomparticipant rp2
                             JOIN user u ON rp2.user_id = u.user_id
                    WHERE rp2.room_id = cr.room_id
                      AND rp2.user_id != #{userId}
                AND rp2.left_at IS NULL
                LIMIT 3
            )
        END AS room_name,

            -- [파생 필드] 현재 참여 인원수 (roomparticipant 소문자 확인)
            (SELECT COUNT(*) FROM roomparticipant WHERE room_id = cr.room_id AND left_at IS NULL) AS user_count,

            -- [파생 필드] 마지막 메시지 정보 조회 (message 소문자 확인)
            (SELECT content FROM message WHERE room_id = cr.room_id ORDER BY message_id DESC LIMIT 1) AS last_message_content,
            (SELECT message_type FROM message WHERE room_id = cr.room_id ORDER BY message_id DESC LIMIT 1) AS last_message_type,
            (SELECT created_at FROM message WHERE room_id = cr.room_id ORDER BY message_id DESC LIMIT 1) AS last_message_time,

            -- 내가 읽지 않은 메세지 개수 (messagereadstatus 소문자 확인)
            (SELECT COUNT(*)
            FROM message m
            JOIN messagereadstatus mrs ON m.message_id = mrs.message_id
            WHERE m.room_id = cr.room_id
            AND mrs.user_id = #{userId}
        AND mrs.is_read = 0) AS unread_count

        FROM chatroom cr
        INNER JOIN roomparticipant rp ON cr.room_id = rp.room_id
        WHERE rp.user_id = #{userId}
        AND rp.left_at IS NULL
        ORDER BY last_message_time DESC, cr.created_at DESC
    </select>

    <select id="getParticipantNamesExceptMe" resultType="string">
        SELECT u.user_name
        FROM roomparticipant rp
                 JOIN user u ON rp.user_id = u.user_id
        WHERE rp.room_id = #{roomId}
          AND rp.user_id != #{userId}
          AND rp.left_at IS NULL
        ORDER BY u.user_name ASC
    </select>

    <select id="findRoomById" parameterType="Long" resultMap="ChatRoomResultMap">
        SELECT
            cr.*,
            (SELECT COUNT(*) FROM roomparticipant WHERE room_id = cr.room_id AND left_at IS NULL) AS user_count
        FROM chatroom cr
        WHERE cr.room_id = #{roomId}
    </select>

    <insert id="addParticipant">
        INSERT INTO roomparticipant (room_id, user_id)
        VALUES (#{param1}, #{param2})
    </insert>

    <update id="leaveRoom">
        UPDATE roomparticipant
        SET left_at = NOW()
        WHERE room_id = #{param1} AND user_id = #{param2}
    </update>

    <select id="findAllParticipantIdsByRoomId" resultType="long">
        SELECT user_id
        FROM roomparticipant
        WHERE room_id = #{roomId}
          AND left_at IS NULL
    </select>

    <select id="searchUserRooms" resultMap="ChatRoomResultMap">
        SELECT DISTINCT
            cr.room_id,
            cr.room_name,
            cr.room_type,
            cr.creator_id,
            cr.created_at,

            (SELECT content FROM message WHERE room_id = cr.room_id ORDER BY message_id DESC LIMIT 1) AS last_message_content,
        (SELECT message_type FROM message WHERE room_id = cr.room_id ORDER BY message_id DESC LIMIT 1) AS last_message_type,
        (SELECT created_at FROM message WHERE room_id = cr.room_id ORDER BY message_id DESC LIMIT 1) AS last_message_time,

        (SELECT COUNT(*)
        FROM message m
        JOIN messagereadstatus mrs ON m.message_id = mrs.message_id
        WHERE m.room_id = cr.room_id
        AND mrs.user_id = #{userId}
            AND mrs.is_read = 0) AS unread_count

        FROM chatroom cr
            INNER JOIN roomparticipant rp ON cr.room_id = rp.room_id
            LEFT JOIN roomparticipant rp2 ON cr.room_id = rp2.room_id
            LEFT JOIN user u ON rp2.user_id = u.user_id
        WHERE rp.user_id = #{userId}
          AND rp.left_at IS NULL
          AND (
            cr.room_name LIKE CONCAT('%', #{keyword}, '%')
           OR u.user_name LIKE CONCAT('%', #{keyword}, '%')
            )
        ORDER BY last_message_time DESC, cr.created_at DESC
    </select>

    <update id="updateReadStatus">
        UPDATE messagereadstatus
        SET is_read = 1
        WHERE user_id = #{userId}
          AND message_id IN (SELECT message_id FROM message WHERE room_id = #{roomId})
          AND is_read = 0
    </update>

    <insert id="insertInitialReadStatus">
        INSERT INTO messagereadstatus (message_id, user_id, is_read)
        SELECT #{messageId}, user_id, 0
        FROM roomparticipant
        WHERE room_id = #{roomId}
          AND user_id != #{senderId}
          AND left_at IS NULL
    </insert>
</mapper>