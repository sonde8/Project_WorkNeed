<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Workneed.workneed.Chat.mapper.ChatRoomMapper">
    <resultMap id="ChatRoomResultMap" type="com.Workneed.workneed.Chat.dto.ChatRoomDTO">
        <id property="roomId" column="room_id"></id>
        <result property="roomName" column="room_name"></result>
        <result property="roomType" column="room_type"/>
        <result property="creatorId" column="creator_id"/>
        <result property="createdAt" column="created_at"/>

        <result property="lastMessageContent" column="last_message_content"/>
        <result property="lastMessageTime" column="last_message_time"/>
        <result property="lastMessageType" column="last_message_type"/>
        <result property="userCount" column="user_count"/>
        <result property="unreadCount" column="unread_count"></result>
    </resultMap>

    <!-- 채팅방 생성 -->
    <insert id="createChatRoom" parameterType="ChatRoomDTO" useGeneratedKeys="true" keyProperty="roomId">
        INSERT INTO ChatRoom (room_name, room_type, creator_id)
        VALUES (#{roomName}, #{roomType}, #{creatorId})
    </insert>

    <!-- 채팅방 목록 조회 -->
    <select id="findAllRoomsByUserId" parameterType="Long" resultMap="ChatRoomResultMap">
        SELECT
            cr.room_id,
            cr.room_name,
            cr.room_type,
            cr.creator_id,
            cr.created_at,

            -- 방 이름을 설정하지 않을 때 참여자들의 이름을 조합하는 쿼리
            CASE
                WHEN cr.room_name IS NOT NULL AND cr.room_name != '' THEN cr.room_name
                ELSE (
                    SELECT
                        CASE
                            WHEN COUNT(*) > 3 THEN CONCAT(GROUP_CONCAT(u.user_name ORDER BY u.user_name ASC SEPARATOR ', '), '...')
                            ELSE GROUP_CONCAT(u.user_name ORDER BY u.user_name ASC SEPARATOR ', ')
                        END
                    FROM RoomParticipant rp2
                    JOIN User u ON rp2.user_id = u.user_id
                    WHERE rp2.room_id = cr.room_id
                    AND rp2.user_id != #{userId} -- 목록에 '나'는 제외
                    AND rp2.left_at IS NULL
                    LIMIT 3
                    )
            END AS room_name,

            -- [파생 필드] 현재 참여 인원수
            (SELECT COUNT(*) FROM RoomParticipant WHERE room_id = cr.room_id AND left_at IS NULL) AS user_count,

            -- [파생 필드] 마지막 메시지 내용 조회
            (SELECT content FROM Message WHERE room_id = cr.room_id ORDER BY message_id DESC LIMIT 1) AS last_message_content,

            -- [파생 필드] 마지막 메시지 타입 조회
            (SELECT message_type FROM Message WHERE room_id = cr.room_id ORDER BY message_id DESC LIMIT 1) AS last_message_type,

            -- [파생 필드] 마지막 메시지 시간 조회 (정렬용)
            (SELECT created_at FROM Message WHERE room_id = cr.room_id ORDER BY message_id DESC LIMIT 1) AS last_message_time,

            -- 내가 읽지 않은 메세지 개수 조회
            -- 1. 해당 방의 메세지 중
            -- 2. 메세지 읽음 상태 테이블에 나의 기록이 안 읽음 것들만 카운트
            (SELECT COUNT(*)
            FROM Message m
            JOIN MessageReadStatus mrs ON m.message_id = mrs.message_id
            WHERE m.room_id = cr.room_id
            AND mrs.user_id = #{userId}
            AND mrs.is_read = 0) AS unread_count

        FROM ChatRoom cr
            INNER JOIN RoomParticipant rp ON cr.room_id = rp.room_id
        WHERE rp.user_id = #{userId}
          AND rp.left_at IS NULL -- 방을 나간 상태가 아닌 경우만 조회
        ORDER BY last_message_time DESC, cr.created_at DESC
    </select>

    <!-- 특정 방 상세 정보 조회 -->
    <select id="getParticipantNamesExceptMe" resultType="string">
        SELECT u.user_name
        FROM RoomParticipant rp
        JOIN User u ON rp.user_id = u.user_id
        WHERE rp.room_id = #{roomId}
        AND rp.user_id != #{userId}
        AND rp.left_at IS NULL
        ORDER BY u.user_name ASC
    </select>

    <select id="findRoomById" parameterType="Long" resultMap="ChatRoomResultMap">
        SELECT
            cr.*,
            (SELECT COUNT(*) FROM RoomParticipant WHERE room_id = cr.room_id AND left_at IS NULL) AS user_count
        FROM ChatRoom cr
        WHERE cr.room_id = #{roomId}
    </select>

    <!-- 채팅방 참여 (특정 사용자를 채팅방 멤버로 초대) -->
    <insert id="addParticipant">
        INSERT INTO RoomParticipant (room_id, user_id)
        VALUES (#{param1}, #{param2})
    </insert>

    <!-- 채팅방 나가기 -->
    <update id="leaveRoom">
        UPDATE RoomParticipant
        SET left_at = NOW()
        WHERE room_id = #{param1} AND user_id = #{param2}
    </update>

    <select id="findAllParticipantIdsByRoomId" resultType="long">
        SELECT user_id
        FROM RoomParticipant
        WHERE room_id = #{roomId}
        AND left_at IS NULL
    </select>

    <!-- 채팅방 검색 -->
    <select id="searchUserRooms" resultMap="ChatRoomResultMap">
        SELECT DISTINCT
            cr.room_id,
            cr.room_name,
            cr.room_type,
            cr.creator_id,
            cr.created_at,

        -- 마지막 메시지 내용
        (SELECT content FROM Message WHERE room_id = cr.room_id ORDER BY message_id DESC LIMIT 1) AS last_message_content,
        -- 마지막 메시지 타입
        (SELECT message_type FROM Message WHERE room_id = cr.room_id ORDER BY message_id DESC LIMIT 1) AS last_message_type,
        -- 마지막 메시지 시간
        (SELECT created_at FROM Message WHERE room_id = cr.room_id ORDER BY message_id DESC LIMIT 1) AS last_message_time,

        -- 안 읽은 개수 표시 (FROM 절 이전에 위치해야 합니다)
        (SELECT COUNT(*)
        FROM Message m
        JOIN MessageReadStatus mrs ON m.message_id = mrs.message_id
        WHERE m.room_id = cr.room_id
        AND mrs.user_id = #{userId}
        AND mrs.is_read = 0) AS unread_count

        FROM ChatRoom cr
            INNER JOIN RoomParticipant rp ON cr.room_id = rp.room_id
            LEFT JOIN RoomParticipant rp2 ON cr.room_id = rp2.room_id
            LEFT JOIN User u ON rp2.user_id = u.user_id
        WHERE rp.user_id = #{userId}
            AND rp.left_at IS NULL
            AND (
            cr.room_name LIKE CONCAT('%', #{keyword}, '%')
            OR u.user_name LIKE CONCAT('%', #{keyword}, '%')
            )
        ORDER BY last_message_time DESC, cr.created_at DESC
    </select>

    <!-- 읽음 상태 확인 -->
    <update id="updateReadStatus">
        UPDATE MessageReadStatus
        SET is_read = 1
        WHERE user_id = #{userId}
        AND message_id IN (SELECT message_id FROM Message WHERE room_id = #{roomId})
        AND is_read = 0
    </update>

    <insert id="insertInitialReadStatus">
        INSERT INTO MessageReadStatus (message_id, user_id, is_read)
        SELECT #{messageId}, user_id, 0
        FROM RoomParticipant
        WHERE room_id = #{roomId}
        AND user_id != #{senderId}
        AND left_at IS NULL
    </insert>
</mapper>