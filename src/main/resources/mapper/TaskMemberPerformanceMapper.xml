<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.Workneed.workneed.Schedule.mapper.TaskMemberPerformanceMapper">

    <!-- 모달1: 참여자별 성과 -->
    <select id="selectMembersPerformance" resultType="com.Workneed.workneed.Schedule.dto.TaskMember1PerformanceDTO">
        SELECT
        u.user_id               AS userId,
        u.user_name             AS userName,
        u.user_profile_image    AS userProfileImage,
        d.dept_name             AS deptName,
        r.rank_name             AS rankName,

        (
        COALESCE(SUM(CASE WHEN mt.personal_status = 'TODO'  THEN 1 ELSE 0 END), 0)
        + COALESCE(SUM(CASE WHEN mt.personal_status = 'DOING' THEN 1 ELSE 0 END), 0)
        ) AS pendingCount,

        COALESCE(SUM(CASE WHEN mt.personal_status = 'DONE' THEN 1 ELSE 0 END), 0)
        AS doneCount,

        COUNT(mt.task_id) AS totalCount,

        CASE
        WHEN COUNT(mt.task_id) = 0 THEN 0
        ELSE ROUND(
        (COALESCE(SUM(CASE WHEN mt.personal_status = 'DONE' THEN 1 ELSE 0 END), 0) * 100.0)
        / COUNT(mt.task_id)
        )
        END AS progressRate

        FROM schedule_participant sp
        JOIN `user` u       ON u.user_id = sp.user_id
        LEFT JOIN dept d    ON d.dept_id = u.dept_id
        LEFT JOIN ranks r   ON r.rank_id = u.rank_id
        LEFT JOIN my_task mt
        ON mt.schedule_id = sp.schedule_id
        AND mt.user_id     = sp.user_id

        WHERE sp.schedule_id = #{scheduleId}

        GROUP BY
        u.user_id, u.user_name, u.user_profile_image,
        d.dept_name, r.rank_name

        ORDER BY progressRate DESC, u.user_id ASC
    </select>


    <!-- 모달1 상단: 스케줄 전체 진행률(전체 DOING / 전체 TASK) -->
    <select id="selectScheduleProgressRate" resultType="int">

        SELECT
            CASE
                WHEN COUNT(mt.task_id) = 0 THEN 0
                ELSE ROUND(
                    (SUM(CASE WHEN mt.personal_status = 'DONE' THEN 1 ELSE 0 END) * 100.0)
                    / COUNT(mt.task_id)
                )
            END
        FROM my_task mt
        WHERE mt.schedule_id = #{scheduleId}

    </select>

</mapper>