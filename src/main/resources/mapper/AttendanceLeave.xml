<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Workneed.workneed.Attendance.mapper.LeaveMapper">

    <insert id="insertRequest"
            parameterType="com.Workneed.workneed.Attendance.dto.LeaveRequestInsertDTO"
            useGeneratedKeys="true" keyProperty="requestId">
        INSERT INTO `request` (user_id, request_type, request_payload, status)
        VALUES (#{userId}, #{requestType}, #{requestPayload}, #{status})
    </insert>

    <insert id="insertLeaveUsage"
            parameterType="com.Workneed.workneed.Attendance.dto.LeaveUsageInsertDTO">
        INSERT INTO leave_usage (request_id, user_id, leave_type, start_date, end_date,  reason)
        VALUES (#{requestId}, #{userId}, #{leaveType}, #{startDate}, #{endDate}, #{reason})
    </insert>

    <select id="selectLeaveUsage"
            resultType="com.Workneed.workneed.Attendance.dto.LeaveUseDTO">
        SELECT
            leave_id   AS leaveId,
            request_id AS requestId,
            user_id    AS userId,
            leave_type AS leaveType,
            start_date AS startDate,
            end_date   AS endDate,

            reason     AS reason,
            created_at AS createdAt
        FROM leave_usage
        WHERE user_id = #{userId}
          AND start_date &lt; #{end}
          AND end_date   &gt; #{start}
        ORDER BY start_date ASC
    </select>

    <select id="selectUserJoinDate" resultType="java.time.LocalDate">
        SELECT DATE(user_created_at)
        FROM user
        WHERE user_id = #{userId}
    </select>

    <select id="countOver" resultType="int">
        SELECT COUNT(*)
        FROM leave_usage
        WHERE user_id = #{userId}
          AND start_date &lt; #{endDate}
          AND end_date   &gt; #{startDate}
    </select>


    <select id="selectDeptIdByUserId" resultType="long">
        SELECT dept_id
        FROM user
        WHERE user_id = #{userId}
    </select>

    <select id="selectDeptLeaveUsage"
            resultType="com.Workneed.workneed.Attendance.dto.LeaveTeamUseDTO">
        SELECT
        lu.leave_id   AS leaveId,
        lu.request_id AS requestId,
        lu.user_id    AS userId,

        u.user_name   AS userName,
        r.rank_name   AS rankName,

        lu.leave_type AS leaveType,
        lu.start_date AS startDate,
        lu.end_date   AS endDate,

        lu.reason     AS reason,

        req.status    AS status,
        lu.created_at AS createdAt
        FROM leave_usage lu
        JOIN user u ON u.user_id = lu.user_id
        JOIN ranks r ON r.rank_id = u.rank_id
        JOIN request req ON req.request_id = lu.request_id
        WHERE u.dept_id = #{deptId}
        AND lu.start_date &lt; #{end}
        AND lu.end_date   &gt; #{start}
        <if test="name != null and name != ''">
            AND u.user_name LIKE CONCAT('%', #{name}, '%')
        </if>
        ORDER BY lu.start_date ASC, u.user_name ASC
    </select>


</mapper>
