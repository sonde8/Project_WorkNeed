<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì - ì§ì›ê´€ë¦¬</title>
    <style>
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        .admin-controls { background: #f9f9f9; padding: 15px; border: 1px solid #ddd; margin-bottom: 20px; }
        .flex-container { display: flex; gap: 30px; align-items: center; }

        #editModal {
            display:none;
            position:fixed;
            top:50%;
            left:50%;
            transform: translate(-50%, -50%);
            background:white;
            border:2px solid #000;
            padding:20px;
            z-index:100;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            min-width: 300px;
        }
    </style>
</head>
<body>

<h2>ì§ì› ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>

<div class="admin-controls">
    <div class="flex-container">
        <div>
            <strong>ğŸ¢ ë¶€ì„œ ë“±ë¡:</strong>
            <input type="text" id="newDeptName" placeholder="ìƒˆ ë¶€ì„œëª…">
            <button type="button" onclick="fnAddDept()">ì¶”ê°€</button>
        </div>
        <div>
            <strong>ğŸ–ï¸ ì§ê¸‰ ë“±ë¡:</strong>
            <input type="text" id="newRankName" placeholder="ìƒˆ ì§ê¸‰ëª…">
            <button type="button" onclick="fnAddRank()">ì¶”ê°€</button>
        </div>
    </div>
</div>

<div style="margin-bottom: 10px;">
    <strong>ìƒíƒœ ë³€ê²½:</strong>
    <select id="batchStatus">
        <option value="ACTIVE">í™œì„±(ACTIVE)</option>
        <option value="INACTIVE">ë¹„í™œì„±(INACTIVE)</option>
        <option value="SUSPENDED">ì •ì§€(SUSPENDED)</option>
        <option value="BANNED">ì°¨ë‹¨(BANNED)</option>
    </select>
    <button type="button" onclick="fnBatchUpdate()">ì¼ê´„ ì ìš©</button>
</div>

<table>
    <thead>
    <tr>
        <th><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
        <th>ì•„ì´ë””</th>
        <th>ì´ë¦„</th>
        <th>ë¶€ì„œ</th>
        <th>ì§ê¸‰</th>
        <th>ìƒíƒœ</th>
        <th>ìˆ˜ì •</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="u : ${user}">
        <td><input type="checkbox" name="userCheck" th:value="${u.userId}"></td>
        <td th:text="${u.userLoginId}">ì•„ì´ë””</td>
        <td th:text="${u.userName}">ì´ë¦„</td>
        <td th:text="${u.deptName}">ë¶€ì„œ</td>
        <td th:text="${u.rankName}">ì§ê¸‰</td>
        <td th:text="${u.userStatus}">ìƒíƒœ</td>
        <td>
            <button th:onclick="openModal([[${u.userId}]], [[${u.deptId}]], [[${u.rankId}]], [[${u.userStatus}]])">ì •ë³´
                ë³€ê²½
            </button>
        </td>
    </tr>
    </tbody>
</table>

<div id="editModal">
    <h3>ì •ë³´ ìˆ˜ì •</h3>
    <input type="hidden" id="targetUserId">

    <p><label>ë¶€ì„œ:</label>
        <select id="modalDept">
            <option th:each="d : ${dept}" th:value="${d.deptId}" th:text="${d.deptName}"></option>
        </select></p>

    <p><label>ì§ê¸‰:</label>
        <select id="modalRank">
            <option th:each="r : ${rank}" th:value="${r.rankId}" th:text="${r.rankName}"></option>
        </select></p>

    <p><label>ìƒíƒœ:</label>
        <select id="modalStatus">
            <option value="ACTIVE">ACTIVE (ì •ìƒ)</option>
            <option value="INACTIVE">INACTIVE (ë¹„í™œì„±)</option>
            <option value="SUSPENDED">SUSPENDED (ì •ì§€)</option>
            <option value="BANNED">BANNED (ì°¨ë‹¨)</option>
        </select></p>

    <br>
    <button onclick="saveChanges()">ì €ì¥</button>
    <button onclick="closeModal()">ì·¨ì†Œ</button>
</div>

<script th:inline="javascript">
    // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤
    function toggleAll(source) {
        const checkboxes = document.querySelectorAll('input[name="userCheck"]');
        checkboxes.forEach(cb => cb.checked = source.checked);
    }

    // ëª¨ë‹¬ ì œì–´
    function openModal(id, deptId, rankId, status) {
        document.getElementById('targetUserId').value = id;
        document.getElementById('modalDept').value = deptId;
        document.getElementById('modalRank').value = rankId;
        document.getElementById('modalStatus').value = status;
        document.getElementById('editModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    // [ê¸°ëŠ¥ 1] ë¶€ì„œ ì¶”ê°€
    function fnAddDept() {
        const name = document.getElementById('newDeptName').value;
        if(!name) return alert("ë¶€ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
        fetch('/admin/dept/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ deptName: name })
        }).then(res => res.text()).then(result => {
            if(result === "success") { alert("ë¶€ì„œ ì¶”ê°€ ì™„ë£Œ"); location.reload(); }
        });
    }

    // [ê¸°ëŠ¥ 2] ì§ê¸‰ ì¶”ê°€
    function fnAddRank() {
        const name = document.getElementById('newRankName').value;
        if(!name) return alert("ì§ê¸‰ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
        fetch('/admin/rank/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ rankName: name })
        }).then(res => res.text()).then(result => {
            if(result === "success") { alert("ì§ê¸‰ ì¶”ê°€ ì™„ë£Œ"); location.reload(); }
        });
    }

    // [ê¸°ëŠ¥ 3] ê°œë³„ ì •ë³´ ì €ì¥
    function saveChanges() {
        const data = {
            userId: document.getElementById('targetUserId').value,
            deptId: document.getElementById('modalDept').value,
            rankId: document.getElementById('modalRank').value,
            userStatus: document.getElementById('modalStatus').value
        };
        fetch('/admin/member/edit/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(res => res.text()).then(result => {
            if (result === "success") { alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); location.reload(); }
        });
    }

    // [ê¸°ëŠ¥ 4] ì¼ê´„ ìƒíƒœ ë³€ê²½
    function fnBatchUpdate() {
        const selectedIds = [];
        document.querySelectorAll('input[name="userCheck"]:checked').forEach(cb => {
            selectedIds.push(cb.value);
        });
        if (selectedIds.length === 0) return alert("ìœ ì €ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

        const status = document.getElementById('batchStatus').value;
        const params = new URLSearchParams();
        selectedIds.forEach(id => params.append('userIds', id));
        params.append('status', status);

        fetch('/admin/member/batch-update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        }).then(res => res.text()).then(result => {
            if (result === "success") { alert('ì¼ê´„ ë³€ê²½ ì™„ë£Œ'); location.reload(); }
        });
    }
</script>

</body>
</html>