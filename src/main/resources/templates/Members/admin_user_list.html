<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì - ì§ì›ê´€ë¦¬ (í†µí•©ë³¸)</title>
    <link rel="stylesheet" th:href="@{/css/admin_user_list.css}">
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ë° ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        #editModal, .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; }
        .modal-content { background:#fff; margin:10% auto; padding:25px; width:400px; border-radius:12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .admin-controls { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; }
        .flex-container { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; font-weight: bold; }
        .btn-delete-small { background: #e53e3e; color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; margin-left: 5px; font-size: 11px; }
    </style>
</head>
<body>

<div class="admin-header" th:if="${admin != null}"
     style="padding: 15px; background: #fff; border-bottom: 1px solid #ddd; margin-bottom: 20px;">
    <span> ê´€ë¦¬ì: <b th:text="${admin.adminName}">ê´€ë¦¬ì</b></span>
    <span style="margin-left:10px;"> | ê¶Œí•œ: <b th:text="${admin.roleName}">ê¶Œí•œ</b></span>
    <form th:action="@{/logout}" method="post" style="display:inline; float: right;">
        <button type="submit" class="btn-secondary" style="padding: 5px 12px; cursor: pointer;">ë¡œê·¸ì•„ì›ƒ</button>
    </form>
</div>

<div style="padding: 0 20px;">

    <div style="display: flex; gap: 20px; border-bottom: 1px solid #ddd; margin-bottom: 20px;">
        <a th:href="@{/admin/member/list}" style="padding: 10px 20px; text-decoration: none; color: #3182ce; border-bottom: 3px solid #3182ce; font-weight: bold;">ì§ì› ê´€ë¦¬</a>
        <a th:href="@{/admin/manage/list}" style="padding: 10px 20px; text-decoration: none; color: #666;">ê´€ë¦¬ì ì„¤ì •</a>
        <a th:href="@{/admin/log/list}" style="padding: 10px 20px; text-decoration: none; color: #666;">í™œë™ ë¡œê·¸</a>
    </div>


    <h2> ì§ì› ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>

    <div class="admin-controls">
        <form th:action="@{/admin/member/list}" method="get">
            <div class="flex-container">
                <div>
                    <strong>ğŸ” ê²€ìƒ‰:</strong>
                    <input type="text" name="userLoginId" th:value="${param.userLoginId}" placeholder="ì•„ì´ë””"
                           style="padding:6px;">
                    <input type="text" name="userName" th:value="${param.userName}" placeholder="ì´ë¦„"
                           style="padding:6px;">
                </div>
                <div>
                    <strong> ë¶€ì„œ:</strong>
                    <select name="deptId" style="padding:6px;">
                        <option value="">ì „ì²´</option>
                        <option th:each="d : ${dept}" th:value="${d.deptId}" th:text="${d.deptName}"
                                th:selected="${#strings.equals(param.deptId, d.deptId)}"></option>
                    </select>
                </div>
                <div>
                    <strong> ìƒíƒœ:</strong>
                    <select name="userStatus" style="padding:6px;">
                        <option value="">ì „ì²´</option>
                        <option value="ACTIVE" th:selected="${param.userStatus == 'ACTIVE'}">í™œì„±</option>
                        <option value="INACTIVE" th:selected="${param.userStatus == 'INACTIVE'}">ë¹„í™œì„±</option>
                        <option value="SUSPENDED" th:selected="${param.userStatus == 'SUSPENDED'}">ì •ì§€</option>
                        <option value="BANNED" th:selected="${param.userStatus == 'BANNED'}">ì°¨ë‹¨</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary"
                        style="background:#3182ce; color:white; border:none; padding:7px 20px; border-radius:4px; cursor:pointer;">
                    ì¡°íšŒ
                </button>
                <a th:href="@{/admin/member/list}" style="font-size:12px; color:#666; text-decoration:none;">ì´ˆê¸°í™”</a>
            </div>
        </form>
    </div>

    <table>
        <thead>
        <tr>
            <th><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
            <th>ì•„ì´ë””</th>
            <th>ì´ë¦„</th>
            <th>ë¶€ì„œ</th>
            <th>ì§ê¸‰</th>
            <th>ìƒíƒœ</th>
            <th>ìˆ˜ì •</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="u : ${user}">
            <td><input type="checkbox" name="userCheck" th:value="${u.userId}"></td>
            <td th:text="${u.userLoginId}">ì•„ì´ë””</td>
            <td th:text="${u.userName}">ì´ë¦„</td>
            <td th:text="${u.deptName}">ë¶€ì„œ</td>
            <td th:text="${u.rankName}">ì§ê¸‰</td>
            <td th:text="${u.userStatus}">ìƒíƒœ</td>
            <td>
                <button class="btn-secondary"
                        th:onclick="openEditModal([[${u.userId}]], [[${u.deptId}]], [[${u.rankId}]], [[${u.userStatus}]])">
                    ì •ë³´ ë³€ê²½
                </button>
            </td>
        </tr>
        </tbody>
    </table>

    <div style="display: flex; justify-content: space-between; margin-top: 20px; align-items: center;">
        <div>
            <strong>âœ… ì„ íƒ íšŒì› ìƒíƒœ ë³€ê²½:</strong>
            <select id="batchStatus" style="padding:6px;">
                <option value="ACTIVE">í™œì„±(ACTIVE)</option>
                <option value="INACTIVE">ë¹„í™œì„±(INACTIVE)</option>
                <option value="SUSPENDED">ì •ì§€(SUSPENDED)</option>
                <option value="BANNED">ì°¨ë‹¨(BANNED)</option>
            </select>
            <button type="button" onclick="fnBatchUpdate()" class="btn-primary"
                    style="padding:7px 15px; cursor:pointer;">ì¼ê´„ ì ìš©
            </button>
        </div>

        <div style="display: flex; gap: 8px;">
            <button onclick="openModal('deptAddModal')"
                    style="background:#2d3748; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">
                + ë¶€ì„œ ê´€ë¦¬
            </button>
            <button onclick="openModal('rankAddModal')"
                    style="background:#2d3748; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">
                + ì§ê¸‰ ê´€ë¦¬
            </button>
            <button onclick="openModal('adminAddModal')"
                    style="background:#38a169; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">
                + ê´€ë¦¬ì ìƒì„±
            </button>
        </div>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3> ì •ë³´ ìˆ˜ì •</h3>
        <input type="hidden" id="targetUserId">
        <p><label>ë¶€ì„œ:</label> <select id="modalDept" style="width:100%; padding:8px;">
            <option th:each="d : ${dept}" th:value="${d.deptId}" th:text="${d.deptName}"></option>
        </select></p>
        <p><label>ì§ê¸‰:</label> <select id="modalRank" style="width:100%; padding:8px;">
            <option th:each="r : ${rank}" th:value="${r.rankId}" th:text="${r.rankName}"></option>
        </select></p>
        <p><label>ìƒíƒœ:</label> <select id="modalStatus" style="width:100%; padding:8px;">
            <option value="ACTIVE">ACTIVE (ì •ìƒ)</option>
            <option value="INACTIVE">INACTIVE (ë¹„í™œì„±)</option>
            <option value="SUSPENDED">SUSPENDED (ì •ì§€)</option>
            <option value="BANNED">BANNED (ì°¨ë‹¨)</option>
        </select></p>
        <div style="text-align: right; margin-top:20px;">
            <button onclick="saveChanges()" class="btn-primary" style="padding:8px 15px; cursor:pointer;">ì €ì¥</button>
            <button onclick="closeModal('editModal')" class="btn-secondary" style="padding:8px 15px; cursor:pointer;">
                ì·¨ì†Œ
            </button>
        </div>
    </div>
</div>

<div id="deptAddModal" class="modal">
    <div class="modal-content">
        <h3> ë¶€ì„œ ê´€ë¦¬</h3>
        <div style="margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #eee;">
            <input type="text" id="newDeptName" placeholder="ìƒˆ ë¶€ì„œëª…" style="width:70%; padding:8px;">
            <button onclick="fnAddDept()" class="btn-primary" style="padding:8px 12px; cursor:pointer;">ì¶”ê°€</button>
        </div>
        <div style="max-height: 200px; overflow-y: auto;">
            <p th:each="d : ${dept}"
               style="display:flex; justify-content:space-between; align-items:center; margin:5px 0;">
                <span th:text="${d.deptName}">ë¶€ì„œëª…</span>
                <button th:if="${d.deptId != 6}" class="btn-delete-small" th:onclick="fnDeleteDept([[${d.deptId}]])">
                    ì‚­ì œ
                </button>
            </p>
        </div>
        <div style="text-align: right; margin-top:15px;">
            <button onclick="closeModal('deptAddModal')" class="btn-secondary">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div id="rankAddModal" class="modal">
    <div class="modal-content">
        <h3> ì§ê¸‰ ê´€ë¦¬</h3>
        <div style="margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #eee;">
            <input type="text" id="newRankName" placeholder="ìƒˆ ì§ê¸‰ëª…" style="width:70%; padding:8px;">
            <button onclick="fnAddRank()" class="btn-primary" style="padding:8px 12px; cursor:pointer;">ì¶”ê°€</button>
        </div>
        <div style="max-height: 200px; overflow-y: auto;">
            <p th:each="r : ${rank}"
               style="display:flex; justify-content:space-between; align-items:center; margin:5px 0;">
                <span th:text="${r.rankName}">ì§ê¸‰ëª…</span>
                <button th:if="${r.rankId != 6}" class="btn-delete-small" th:onclick="fnDeleteRank([[${r.rankId}]])">
                    ì‚­ì œ
                </button>
            </p>
        </div>
        <div style="text-align: right; margin-top:15px;">
            <button onclick="closeModal('rankAddModal')" class="btn-secondary">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div id="adminAddModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">ğŸ‘¤ ì‹ ê·œ ê´€ë¦¬ì ìƒì„±</h3>
        <div style="text-align:left;">
            <label>ì´ë¦„</label>
            <input type="text" id="newAdminName"
                   style="width:100%; padding:8px; margin-bottom:10px; box-sizing:border-box;">
            <label>ì´ë©”ì¼(ì•„ì´ë””)</label>
            <input type="email" id="newAdminEmail"
                   style="width:100%; padding:8px; margin-bottom:10px; box-sizing:border-box;">
            <label>ë¹„ë°€ë²ˆí˜¸</label>
            <div style="position:relative; margin-bottom:5px;">
                <input type="password" id="newAdminPassword" placeholder="8ìë¦¬ ì´ìƒ, íŠ¹ìˆ˜ë¬¸ì í¬í•¨"
                       style="width:100%; padding:8px; padding-right:40px; box-sizing:border-box;">
                <span id="togglePw" onclick="togglePasswordVisibility()"
                      style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:18px;">ğŸ‘ï¸</span>
            </div>
            <p id="pwGuide" style="font-size:11px; color:#666; margin-bottom:15px;">* 8ì ì´ìƒ, ì˜ë¬¸/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ì(@ì œì™¸) í¬í•¨</p>
            <label>ê´€ë¦¬ì ê¶Œí•œ ì„¤ì •</label>
            <select id="newAdminRoleId" style="width:100%; padding:8px; margin-bottom:15px;">
                <option value="">ê¶Œí•œ ì„ íƒ</option>
                <option value="2">ì¸ì‚¬ ê´€ë¦¬ì (HR_MANAGER)</option>
                <option value="3">ì¸ì‚¬ ë‹´ë‹¹ì (HR_STAFF)</option>
            </select>
        </div>
        <div style="text-align: right;">
            <button class="btn-primary" onclick="saveNewAdmin()"
                    style="background-color: #38a169; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">
                ê³„ì • ìƒì„±
            </button>
            <button class="btn-secondary" onclick="closeModal('adminAddModal')"
                    style="padding:8px 15px; cursor:pointer; margin-left:5px;">ì·¨ì†Œ
            </button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /* 1. ê³µí†µ ëª¨ë‹¬ ë° ì²´í¬ë°•ìŠ¤ ì œì–´ */
    function openModal(id) { document.getElementById(id).style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function toggleAll(source) { document.querySelectorAll('input[name="userCheck"]').forEach(cb => cb.checked = source.checked); }

    /* 2. ìœ ì € ì •ë³´ ìˆ˜ì • */
    function openEditModal(id, deptId, rankId, status) {
        document.getElementById('targetUserId').value = id;
        document.getElementById('modalDept').value = deptId;
        document.getElementById('modalRank').value = rankId;
        document.getElementById('modalStatus').value = status;
        openModal('editModal');
    }

    function saveChanges() {
        const data = {
            userId: document.getElementById('targetUserId').value,
            deptId: document.getElementById('modalDept').value,
            rankId: document.getElementById('modalRank').value,
            userStatus: document.getElementById('modalStatus').value
        };
        fetch('/admin/member/edit/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(res => res.text()).then(result => {
            if (result === "success") { alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); location.reload(); }
            else alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    /* 3. ì¼ê´„ ìƒíƒœ ë³€ê²½ */
    function fnBatchUpdate() {
        const selectedIds = Array.from(document.querySelectorAll('input[name="userCheck"]:checked')).map(cb => cb.value);
        if (selectedIds.length === 0) return alert("ìœ ì €ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        const status = document.getElementById('batchStatus').value;
        const params = new URLSearchParams();
        selectedIds.forEach(id => params.append('userIds', id));
        params.append('status', status);

        fetch('/admin/member/batch-update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        }).then(res => res.text()).then(result => {
            if (result === "success") { alert('ì¼ê´„ ë³€ê²½ ì™„ë£Œ'); location.reload(); }
        });
    }

    /* 4. ë¶€ì„œ ì¶”ê°€ ë° ì‚­ì œ */
    function fnAddDept() {
        const name = document.getElementById('newDeptName').value;
        if(!name) return alert("ë¶€ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
        fetch('/admin/dept/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ deptName: name })
        }).then(res => res.text()).then(result => { if(result === "success") location.reload(); });
    }

    function fnDeleteDept(id) {
        if(!confirm("í•´ë‹¹ ë¶€ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì†Œì† ì¸ì›ì€ 'ë¯¸ë°°ì •'ìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤.")) return;
        fetch('/admin/dept/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ deptId: id })
        }).then(res => res.text()).then(result => {
            if(result === "success") location.reload();
            else if(result === "is_default") alert("ê¸°ë³¸ ë¶€ì„œëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            else alert("ì‚­ì œ ì‹¤íŒ¨");
        });
    }

    /* 5. ì§ê¸‰ ì¶”ê°€ ë° ì‚­ì œ */
    function fnAddRank() {
        const name = document.getElementById('newRankName').value;
        if(!name) return alert("ì§ê¸‰ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
        fetch('/admin/rank/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ rankName: name })
        }).then(res => res.text()).then(result => { if(result === "success") location.reload(); });
    }

    function fnDeleteRank(id) {
        if(!confirm("í•´ë‹¹ ì§ê¸‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•´ë‹¹ ì¸ì›ì€ 'ì‹ ì…'ìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤.")) return;
        fetch('/admin/rank/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ rankId: id })
        }).then(res => res.text()).then(result => {
            if(result === "success") location.reload();
            else if(result === "is_default") alert("ê¸°ë³¸ ì§ê¸‰ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            else alert("ì‚­ì œ ì‹¤íŒ¨");
        });
    }

    /* 6. ê´€ë¦¬ì ìƒì„± ê´€ë ¨ */
    function togglePasswordVisibility() {
        const pwInput = document.getElementById('newAdminPassword');
        const toggleIcon = document.getElementById('togglePw');
        if (pwInput.type === 'password') { pwInput.type = 'text'; toggleIcon.innerText = 'ğŸ”’'; }
        else { pwInput.type = 'password'; toggleIcon.innerText = 'ğŸ‘ï¸'; }
    }

    function saveNewAdmin() {
        const pwd = document.getElementById('newAdminPassword').value;
        const name = document.getElementById('newAdminName').value;
        const email = document.getElementById('newAdminEmail').value;
        const roleId = document.getElementById('newAdminRoleId').value;
        const pwReg = /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[!#$%^&*()_+|~={}\[\]:";'<>?,.\/]).{8,}$/;

        if(!name || !email || !roleId) return alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if (!pwReg.test(pwd)) return alert("ë¹„ë°€ë²ˆí˜¸ ê·œì •ì„ í™•ì¸í•˜ì„¸ìš”.");

        fetch('/admin/member/add-admin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adminName: name, adminEmail: email, adminPassword: pwd, roleId: roleId })
        }).then(res => res.text()).then(result => {
            if(result === "success") { alert("ê´€ë¦¬ì ìƒì„± ì™„ë£Œ"); location.reload(); }
            else alert("ìƒì„± ì‹¤íŒ¨");
        });

        function changeAdminStatus(targetId, currentStatus) {
    const nextStatus = (currentStatus === 'ACTIVE') ? 'SUSPENDED' : 'ACTIVE';
    const msg = nextStatus === 'SUSPENDED' ? "í•´ë‹¹ ê´€ë¦¬ìë¥¼ ì •ì§€ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?" : "ì •ì§€ë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";

    if(!confirm(msg)) return;

    fetch('/admin/member/admin-status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ targetId: targetId, status: nextStatus })
    }).then(res => res.text()).then(result => {
        if(result === "success") {
            alert("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        }
    });
}




    }
</script>
</body>
</html>