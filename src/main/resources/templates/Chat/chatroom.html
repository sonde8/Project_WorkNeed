<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
    <title layout:fragment="title">Ï±ÑÌåÖ - WORKNEED</title>

    <th:block layout:fragment="head">
        <link rel="stylesheet" th:href="@{/css/chat.css}">
    </th:block>
</head>

<body>
<main layout:fragment="content" class="chat-inner-layout">
    <aside class="chat-sidebar">
        <div class="search-container">
            <input type="text" placeholder="Í≤ÄÏÉâ">
            <button type="button" class="icon-btn">
                <img th:src="@{/images/search300.svg}" width="18" height="18" alt="Í≤ÄÏÉâ">
            </button>
        </div>
        <div id="room-list" class="room-list-scroll">
            <div th:each="r : ${rooms}" class="room-card"
                 th:id="'room-' + ${r.roomId}"
                 th:data-room-id="${r.roomId}"
                 th:classappend="${room != null && r.roomId == room.roomId} ? 'active'">
                <a th:href="@{/chat/room/{id}(id=${r.roomId})}">
                    <div class="profile-img">
                        <img th:src="@{/images/profile300.svg}" alt="ÏÇ¨Ïö©Ïûê">
                    </div>
                    <div class="room-text">
                        <div class="name-row">
                            <span class="name" th:text="${r.roomName}">Ï±ÑÌåÖÎ∞© Ïù¥Î¶Ñ</span>
                            <span class="user-count" th:if="${r.roomType == 'GROUP'}" th:text="${r.userCount}">3</span>
                            <span class="last-time" th:text="${r.lastMessageDisplayTime}">Ïò§ÌõÑ 2:30</span>
                        </div>
                        <div class="preview-row" style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="preview" th:text="${r.lastMessageContent}">ÎÇ¥Ïö©</span>
                            <span th:id="'unread-badge-' + ${r.roomId}"
                                  th:class="${r.unreadCount > 0} ? 'unread-badge' : 'unread-badge hidden'"
                                  th:text="${r.unreadCount}">0</span>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </aside>

    <section class="chat-view">
        <div class="chat-main-content">
            <header class="view-header">
                <div class="current-user">
                    <th:block th:if="${room != null}">
                        <div class="profile-img-sm">
                            <img th:src="@{/images/profile300.svg}" alt="ÌîÑÎ°úÌïÑ">
                        </div>
                        <strong th:text="${room.roomName}">Î∞© Ïù¥Î¶Ñ</strong>
                    </th:block>
                </div>

                <div class="header-icons">
                    <th:block th:if="${room != null}">
                        <button type="button" class="icon-btn" title="Î∞© Î™©Î°ùÏúºÎ°ú" onclick="location.href='/chat/rooms'">
                            <img th:src="@{/images/close300.svg}" width="22" height="22" alt="Îã´Í∏∞">
                        </button>
                        <button type="button" class="icon-btn" title="ÎØ∏ÎîîÏñ¥ ÏÑúÎûç" onclick="toggleChatSidebar()">
                            <img th:src="@{/images/sidebar300.svg}" width="22" height="22" alt="Î©îÎâ¥">
                        </button>
                        <button type="button" class="icon-btn" title="Ï±ÑÌåÖÎ∞© ÎÇòÍ∞ÄÍ∏∞" onclick="leaveRoom()">
                            <img th:src="@{/images/exit300.svg}" width="22" height="22" alt="ÎÇòÍ∞ÄÍ∏∞">
                        </button>
                    </th:block>
                    <th:block th:unless="${room != null}">
                        <button type="button" class="icon-btn" title="Ï±ÑÌåÖÎ∞© ÏÉùÏÑ±" onclick="openCreateRoomModal()">
                            <img th:src="@{/images/chatadd300.svg}" width="24" height="24" alt="Î∞© ÏÉùÏÑ±">
                        </button>
                    </th:block>
                </div>
            </header>

            <th:block th:if="${room != null}">
                <ul id="messageLog" class="message-log">
                    <th:block th:each="msg, iterStat : ${history}">
                        <th:block th:with="currDate=${#temporals.format(msg.createdAt, 'yyyy-MM-dd')},
                                               prevDate=${!iterStat.first ? #temporals.format(history[iterStat.index - 1].createdAt, 'yyyy-MM-dd') : ''}">
                            <li th:if="${currDate != prevDate}" class="system-msg date-divider">
                                <div class="system-inner">
                                    <span th:text="${#temporals.format(msg.createdAt, 'yyyyÎÖÑ MMÏõî ddÏùº EEEE')}"></span>
                                </div>
                            </li>
                        </th:block>

                        <li th:class="${msg.messageType != null && #strings.trim(msg.messageType).toUpperCase() == 'ENTER'} ? 'system-msg' : (${msg.senderId == currentUserId} ? 'my-msg' : 'other-msg')">
                            <th:block th:if="${msg.messageType != null && #strings.trim(msg.messageType).toUpperCase() == 'ENTER'}">
                                <div class="system-inner">
                                    <span th:text="${msg.content}">ÏãúÏä§ÌÖú Î©îÏãúÏßÄ</span>
                                </div>
                            </th:block>
                            <th:block th:unless="${msg.messageType != null && #strings.trim(msg.messageType).toUpperCase() == 'ENTER'}">
                                <div class="msg-unit">
                                    <span class="sender" th:if="${msg.senderId != currentUserId}" th:text="${msg.senderName}">Ïù¥Î¶Ñ</span>
                                    <div class="bubble-row">
                                        <div class="bubble">
                                            <th:block th:with="mType=${msg.messageType != null ? #strings.trim(msg.messageType).toUpperCase() : 'TALK'}" th:switch="${mType}">
                                                <img th:case="'IMAGE'" th:src="${msg.content}"
                                                     style="max-width: 250px; border-radius: 8px; display: block; cursor: pointer;"
                                                     th:onclick="openImageModal(this.src)">
                                                <a th:case="'FILE'" th:href="${msg.content}" download class="file-link">
                                                    üìé <span th:text="${#strings.contains(msg.content, '_') ? #strings.substringAfter(msg.content, '_') : 'ÌååÏùº Îã§Ïö¥Î°úÎìú'}">ÌååÏùºÎ™Ö</span>
                                                </a>
                                                <span th:case="*" th:text="${msg.content}"></span>
                                            </th:block>
                                        </div>
                                        <div class="msg-info">
                                            <span class="unread-count" th:if="${msg.unreadCount > 0}" th:text="${msg.unreadCount}"></span>
                                            <span class="msg-time" th:text="${#temporals.format(msg.createdAt, 'a h:mm', 'Asia/Seoul')}"></span>
                                        </div>
                                    </div>
                                </div>
                            </th:block>
                        </li>
                    </th:block>
                </ul>

                <footer class="chat-footer">
                    <div class="toolbar">
                        <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleFileUpload(this, 'IMAGE')">
                        <input type="file" id="fileInput" accept="*/*" style="display:none;" onchange="handleFileUpload(this, 'FILE')">
                        <button type="button" class="icon-btn" onclick="document.getElementById('imageInput').click()"><img th:src="@{/images/image300.svg}" width="22"></button>
                        <button type="button" class="icon-btn" onclick="document.getElementById('fileInput').click()"><img th:src="@{/images/attach_file300.svg}" width="22"></button>
                    </div>
                    <form id="messageForm" class="input-form">
                        <textarea id="message" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." rows="2"></textarea>
                        <div class="form-bottom">
                            <span class="info">ÏÇ¨Ïö©ÏûêÎ•º ÌÉúÍ∑∏ÌïòÎ†§Î©¥ @Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</span>
                            <button type="submit" class="send-btn"><img th:src="@{/images/send300.svg}" width="26"></button>
                        </div>
                    </form>
                </footer>
            </th:block>

            <th:block th:unless="${room != null}">
                <div class="empty-chat-view">
                    <p>Ï±ÑÌåÖÎ∞©ÏùÑ ÏÑ†ÌÉùÌïòÏó¨ ÎåÄÌôîÎ•º ÏãúÏûëÌïòÏÑ∏Ïöî.</p>
                </div>
            </th:block>
        </div>

        <div id="mediaSidebar" class="chat-media-sidebar">
            <div class="sidebar-header">
                <h3>Ï±ÑÌåÖÎ∞© ÏÑúÎûç</h3>
                <button class="close-btn" onclick="toggleChatSidebar()">&times;</button>
            </div>
            <div class="sidebar-content">
                <div class="media-section">
                    <div class="section-title">ÏÇ¨ÏßÑ, ÎèôÏòÅÏÉÅ</div>
                    <div id="sidebarImageList" class="image-grid"></div>
                </div>
                <div class="media-section">
                    <div class="section-title">ÌååÏùº</div>
                    <div id="sidebarFileList" class="file-list-vertical"></div>
                </div>
            </div>
        </div>

        <div id="imageModal" class="image-full-modal" onclick="closeImageModal()">
            <div class="modal-top-bar" onclick="event.stopPropagation()">
                <div class="image-info-text">
                    <span id="modalSenderName" class="sender-name">Ïù¥Î¶Ñ</span>
                    <span id="modalSendDate" class="send-date">2025. 12. 27.</span>
                </div>
                <div class="top-bar-icons">
                    <a id="imageDownloadBtn" href="" download class="icon-btn-light" title="Îã§Ïö¥Î°úÎìú">
                        <img th:src="@{/images/download300_2.svg}" width="35" height="35" alt="Îã§Ïö¥Î°úÎìú">
                    </a>
                    <span class="modal-close-new" onclick="closeImageModal()">&times;</span>
                </div>
            </div>
            <div class="modal-content-wrapper" onclick="event.stopPropagation()">
                <button class="nav-btn prev-btn" onclick="changeImage(-1)">&#10094;</button>
                <img id="fullImage" src="" alt="ÌôïÎåÄ Ïù¥ÎØ∏ÏßÄ">
                <button class="nav-btn next-btn" onclick="changeImage(1)">&#10095;</button>
            </div>
        </div>

        <div th:replace="~{Chat/chatModal :: createRoomModal}"></div>
    </section>
</main>

<th:block layout:fragment="script">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script th:inline="javascript">
        window.currentUserId = /*[[${currentUserId != null ? currentUserId : session.user.userId}]]*/ null;
        window.roomId = /*[[${room != null ? room.roomId : null}]]*/ null;
        window.lastDisplayDate = /*[[${history != null && !history.isEmpty() ? #temporals.format(history.get(history.size()-1).createdAt, 'yyyy-MM-dd') : null}]]*/ null;
    </script>
    <script th:src="@{/js/chatModal.js}"></script>
    <script th:src="@{/js/Socket.js}"></script>
</th:block>
</body>
</html>