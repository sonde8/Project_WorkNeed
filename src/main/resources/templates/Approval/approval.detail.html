<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
    <meta charset="UTF-8">
    <title>문서 상세</title>

    <th:block layout:fragment="head">
        <link rel="stylesheet" th:href="@{/css/approve.css}">
    </th:block>
</head>

<body>
<th:block layout:fragment="content">

    <div class="approval-scope">
        <div class="wrap approval-detail">

            <!-- 문서 없음 -->
            <div th:if="${doc == null}" class="card">
                <div class="card-head">
                    <h3>오류</h3>
                    <p class="meta">문서를 찾을 수 없습니다.</p>
                </div>

                <div class="empty">
                    <p>문서를 찾을 수 없습니다.</p>
                    <button type="button" class="btn" onclick="history.back()">뒤로가기</button>
                </div>
            </div>

            <!-- 문서 있음 -->
            <div th:if="${doc != null}">

                <!-- =========================
                     결재 라인
                     ========================= -->
                <div class="card">
                    <div class="card-head">
                        <h3>결재 라인</h3>

                        <!-- 회수 버튼 -->
                        <form th:if="${canRecall}"
                              method="post"
                              th:action="@{/approval/recall}"
                              style="display:inline;">
                            <input type="hidden" name="docId" th:value="${docId}">
                            <button type="submit" class="btn danger"
                                    onclick="return confirm('아직 1차 결재 전인 문서만 회수할 수 있습니다. 회수하시겠습니까?');">
                                회수
                            </button>
                        </form>

                        <!-- 임시저장 + 작성자만 수정 가능 -->
                        <a th:if="${doc.status.name() == 'DRAFT' and doc.writerId == loginUserId}"
                           th:href="@{/approval/edit/{docId}(docId=${doc.docId})}"
                           class="btn btn-outline-primary">
                            수정하기
                        </a>
                    </div>

                    <ul class="line-list">
                        <li th:each="l : ${lines}" class="line-item">

                            <!-- 차수 라벨 -->
                            <span class="ord"
                                  th:text="${l.orderNum == 1 ? '검토' : (l.orderNum == 2 ? '합의' : '최종 결재')}">
                            </span>

                            <!-- 이름 + 부서/직급 -->
                            <span class="cand-name" th:text="${l.username}">이름</span>
                            <span class="cand-meta">
                                (<span th:text="${l.deptName}">부서</span>
                                <span th:if="${l.rankName != null}"
                                      th:text="' / ' + ${l.rankName}"> / 직급</span>)
                            </span>

                            <!-- 상태 배지 -->
                            <span class="status badge"
                                  th:classappend="' st-' + ${#strings.toLowerCase(l.status.name())}"
                                  th:text="${l.status.label}">
                                상태
                            </span>

                        </li>

                        <li th:if="${#lists.isEmpty(lines)}" class="line-empty">
                            결재 라인이 없습니다.
                        </li>
                    </ul>
                </div>

                <!-- =========================
                     ✅ 반려 사유 (추가)
                     - 문서가 REJECTED일 때만 표시
                     - rejectComment 는 컨트롤러에서 model로 넣어둔 값
                     ========================= -->
                <div class="card" th:if="${doc.status.name() == 'REJECTED'}">
                    <div class="card-head">
                        <h3>반려 사유</h3>
                        <p class="meta">반려 처리 시 입력된 사유입니다.</p>
                    </div>

                    <div class="rows">
                        <div class="row-row-content">
                            <span class="label">사유</span>
                            <pre class="content-detail"
                                 th:text="${rejectComment != null ? rejectComment : '반려 사유가 없습니다.'}">-</pre>
                        </div>
                    </div>
                </div>

                <!-- =========================
                     참조자
                     ========================= -->
                <div class="card">
                    <div class="card-head">
                        <h3>참조자</h3>
                        <p class="meta">열람만 가능 (승인/반려 불가)</p>
                    </div>

                    <ul class="line-list">
                        <li th:each="u : ${refUsers}" class="line-item"
                            th:attr="data-user-id=${u.userId},
                                     data-name=${u.username},
                                     data-dept=${u.deptName},
                                     data-rank=${u.rankName}">

                            <span class="cand-name" th:text="${u.username}">이름</span>
                            <span class="cand-meta">
                                (<span th:text="${u.deptName}">부서</span>
                                <span th:if="${u.rankName != null}"
                                      th:text="' / ' + ${u.rankName}"> / 직급</span>)
                            </span>
                        </li>

                        <li th:if="${refUsers == null or #lists.isEmpty(refUsers)}"
                            class="line-empty">
                            참조자가 없습니다.
                        </li>
                    </ul>
                </div>

                <!-- =========================
                     문서 정보
                     ========================= -->
                <div class="card">
                    <div class="card-head">
                        <h3>문서 정보</h3>
                        <p class="meta">문서 기본 정보</p>
                    </div>

                    <div class="rows">

                        <div class="row">
                            <span class="label">제목</span>
                            <span class="value" th:text="${doc.title}">-</span>
                        </div>

                        <div class="row">
                            <span class="label">상태</span>
                            <span class="value badge strong"
                                  th:classappend="' st-' + ${#strings.toLowerCase(doc.status.name())}"
                                  th:text="${doc.status.label}">
                                DRAFT
                            </span>
                        </div>

                        <div class="row">
                            <span class="label">문서 종류</span>
                            <span class="value" th:text="${doc.typeName}">-</span>
                        </div>

                        <!-- ✅ 휴가 정보: 휴가 문서일 때만 표시 (leave가 모델에 있을 때만) -->
                        <div th:if="${leave != null}">
                            <div class="row">
                                <span class="label">휴가 종류</span>
                                <span class="value" th:text="${leave.leaveType}">-</span>
                            </div>
                        </div>



                        <div class="row-row-content">
                            <span class="label">내용</span>
                            <pre class="content-detail" th:text="${doc.content}">-</pre>
                        </div>

                        <div class="row">
                            <span class="label">작성일</span>
                            <span th:text="${#temporals.format(doc.createdAt, 'yyyy년 MM월 dd일 HH:mm')}"></span>
                        </div>

                    </div>
                </div>

                <!-- =========================
                     첨부 파일
                     ========================= -->
                <div class="card">
                    <div class="card-head">
                        <h3>첨부 파일</h3>
                        <p class="meta">첨부된 파일 목록</p>
                    </div>

                    <ul class="app-file-list">
                        <li th:each="f : ${files}" class="app-file-item">

                            <a th:href="@{/approval/file/{id}/download(id=${f.fileId})}"
                               th:text="${f.originalName}"
                               class="app-file-link">파일명.pdf</a>

                            <form th:if="${isWriter}"
                                  th:action="@{/approval/file/{id}/delete(id=${f.fileId})}"
                                  method="post"
                                  onsubmit="return confirm('파일을 삭제하시겠습니까?');">
                                <button type="submit" class="app-btn-delete">삭제</button>
                            </form>
                        </li>

                        <li th:if="${#lists.isEmpty(files)}" class="app-file-empty">
                            첨부 파일이 없습니다.
                        </li>
                    </ul>
                </div>

                <!-- =========================
                     액션 버튼
                     ========================= -->
                <div class="action-panel"
                     th:if="${doc.status.name() == 'IN_PROGRESS' and isMyTurn and !isReference}">

                    <!-- 왼쪽: 안내 -->
                    <div class="action-head">
                        <div class="action-title">결재 처리</div>
                        <div class="action-desc">승인 또는 반려 중 하나를 선택하십시오.</div>
                    </div>

                    <!-- 오른쪽: 버튼 -->
                    <div class="action-buttons">

                        <!-- 승인 -->
                        <form class="inline"
                              method="post" th:action="@{/approval/approve}">
                            <input type="hidden" name="docId" th:value="${doc.docId}">
                            <button type="submit" class="btn action-btn approve"
                                    data-confirm="승인 처리하시겠습니까?">
                                승인
                            </button>
                        </form>

                        <!-- 반려 (토글) -->
                        <button type="button" class="btn action-btn reject" id="btnToggleReject">
                            반려
                        </button>
                    </div>

                    <!-- 반려 폼 -->
                    <form id="rejectForm"
                          class="action-reject-form"
                          method="post" th:action="@{/approval/reject}">
                        <input type="hidden" name="docId" th:value="${doc.docId}">

                        <div class="reject-top">
                            <div class="reject-title">반려 사유</div>
                            <button type="button" class="btn action-btn ghost" id="btnCancelReject">닫기</button>
                        </div>

                        <textarea name="comment"
                                  placeholder="반려 사유를 입력하십시오 (예: 첨부파일 누락, 내용 보완 필요 등)"
                                  required></textarea>

                        <div class="reject-actions">
                            <button type="submit" class="btn action-btn reject solid"
                                    data-confirm="반려 처리하시겠습니까?">
                                반려 확정
                            </button>
                        </div>
                    </form>

                </div>


                <!-- 서버에서 넣어둔 상태를 JS가 읽을 수 있게 -->
                <input type="hidden" id="isMyTurn" th:value="${isMyTurn}">
                <input type="hidden" id="docStatus" th:value="${doc.status.name()}">

            </div>
        </div>
    </div>

</th:block>

<!-- ✅ JS 분리 -->
<th:block layout:fragment="script">
    <script th:src="@{/js/approval.js}"></script>
</th:block>

</body>
</html>
