<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
    <meta charset="UTF-8">
    <title>결재 문서 작성</title>

    <th:block layout:fragment="head">
        <link rel="stylesheet" th:href="@{/css/approve.css}">
    </th:block>
</head>

<body>
<th:block layout:fragment="content">

    <div class="approval-scope">
        <div class="wrap approval-create">

            <div class="page-head">
                <h1 class="page-title"
                    th:text="${mode} == 'edit' ? '임시저장 문서 수정' : '결재 문서 작성'">결재 문서 작성</h1>
                <div class="page-actions">
                    <a class="btn" th:href="@{/approval}">결재함</a>
                </div>
            </div>

            <!-- ✅ form은 1개만 사용 -->
            <form class="card form-card"
                  method="post"
                  enctype="multipart/form-data"
                  th:action="${mode} == 'edit'
                                ? @{/approval/draft/{docId}(docId=${docId})}
                                : @{/approval/save}">

                <!-- edit 모드에서 docId 같이 전송 -->
                <input type="hidden" name="docId" th:value="${docId}">
                <input type="hidden" name="mode" th:value="${mode}">

                <div class="card-head">
                    <h3 th:text="${mode} == 'edit' ? '문서 수정' : '문서 작성'">문서 작성</h3>
                    <p class="meta">문서 유형 / 제목 / 내용 / 첨부</p>
                </div>

                <div class="rows">

                    <!-- 문서 유형 -->
                    <div class="row">
                        <label class="label">문서 유형</label>
                        <select class="control" name="typeId" required>
                            <option value="">문서 유형 선택</option>
                            <option th:each="t : ${types}"
                                    th:value="${t.typeId}"
                                    th:text="${t.typeName}"
                                    th:selected="${doc != null and doc.typeId != null} ? (${doc.typeId} == ${t.typeId}) : false">
                            </option>
                        </select>
                    </div>

                    <!-- 제목 -->
                    <div class="row">
                        <label class="label">제목</label>
                        <input class="control"
                               type="text"
                               name="title"
                               placeholder="제목을 입력하십시오"
                               th:value="${doc != null} ? ${doc.title} : ''"
                               required>
                    </div>

                    <!-- 내용 -->
                    <div class="row row-content">
                        <label class="label">내용</label>
                        <textarea class="control textarea"
                                  name="content"
                                  rows="10"
                                  placeholder="내용을 입력하십시오"
                                  th:text="${doc != null} ? ${doc.content} : ''"
                                  required></textarea>
                    </div>


                    <!-- 첨부 -->
                    <div class="row">
                        <label class="label">첨부 파일</label>
                        <input class="control" type="file" id="fileInput" name="files" multiple onchange="handleFileSelection(this)">
                        <div class="hint"></div>

                        <div id="fileListContainer">
                            <p class="placeholder">선택된 파일이 없습니다.</p>
                        </div>
                    </div>

                </div>

                <!-- =========================
                     결재선 구성 영역 (후보 + 4칸)
                     ========================= -->
                <div class="divider"></div>

                <div class="card-head">
                    <h3>결재선 구성</h3>
                    <p class="meta">결재선은 직급이 낮은 순서부터 높은 순서로 등록해 주세요.</p>
                </div>

                <div class="approver-layout">

                    <!-- 후보 리스트 -->
                    <div class="approver-box">


                        <div class="box-head">
                            <div class="box-title">사용자 후보</div>
                            <div class="box-meta">ACTIVE 사용자</div>
                        </div>
                        <div class="left-user-picker">

                            <!-- 팀 전체 선택 -->
                            <div class="picker-actions">
                                <button type="button" class="btn" id="btnSelectAll">팀 전체 선택</button>
                            </div>

                            <!-- 검색 -->
                            <div class="picker-search">
                                <input type="text" id="userSearchInput" placeholder="이름/부서/직급 검색">
                                <button type="button" class="btn" id="btnSearch">검색</button>
                            </div>

                            <!-- 검색 결과 -->
                            <div class="picker-section">
                                <div class="section-title">검색 결과 <span id="searchCount">0</span></div>
                                <div id="searchResultList" class="list"></div>
                            </div>

                            <!-- 부서별 토글 -->
                            <div class="picker-section">
                                <div class="section-title">부서별 팀원</div>

                                <div class="dept-accordion" th:each="dept : ${departments}">
                                    <button type="button" class="dept-head"
                                            th:attr="data-dept-id=${dept.deptId}">
                                        <span th:text="${dept.deptName}">부서명</span>
                                        <span class="dept-count"
                                              th:text="${#lists.size(usersByDept[dept.deptId])}">0</span>
                                        <span class="dept-toggle-icon">▾</span>
                                    </button>

                                    <div class="dept-body" style="display:none;">
                                        <!-- (선택) 부서 전체 선택 -->
                                        <div class="dept-actions">
                                            <button type="button" class="btn btn-small deptSelectAll"
                                                    th:attr="data-dept-id=${dept.deptId}">부서 전체 선택</button>
                                        </div>

                                        <div class="list">
                                            <div class="row"
                                                 th:each="u : ${usersByDept[dept.deptId]}"
                                                 th:attr="data-user-id=${u.userId},
                        data-name=${u.username},
                        data-dept=${dept.deptName},
                        data-rank=${u.rankName}">
                                                <div class="meta">
                                                    <div class="name" th:text="${u.username}">홍길동</div>
                                                    <div class="sub">
                                                        <span th:text="${dept.deptName}">개발팀</span>
                                                        <span> · </span>
                                                        <span th:text="${u.rankName}">대리</span>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-small btnPick">선택</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                        </div>

                        <!-- 선택된 목록(예: 오른쪽/아래) -->
                        <div class="picked-users">
                            <div class="section-title">선택된 목록</div>
                            <div id="pickedList" class="list"></div>

                            <!-- 서버 전송용 hidden inputs -->
                            <div id="pickedHiddenInputs"></div>
                        </div>
<!--
                        <div class="candidate-list">
                            <label class="candidate" th:each="u : ${approvers}">
                                <input type="checkbox" class="candCheck"
                                       th:value="${u.userId}"
                                       th:data-name="${u.username}"
                                       th:data-dept="${u.deptName}"
                                       th:data-rank="${u.rankName}">
                                <span class="cand-name" th:text="${u.username}">이름</span>
                                <span class="cand-meta">
                                  (<span th:text="${u.deptName}">부서</span>
                                  <span th:if="${u.rankName != null}" th:text="' / ' + ${u.rankName}">/ 직급</span>)
                                </span>
                            </label>
                        </div>
-->
                        <div class="hint">

                            최종결재는 1명만 가능합니다.
                        </div>
                    </div>

                    <!-- 구성/미리보기 -->
                    <div class="approver-box">
                        <div class="box-head">
                            <div class="box-title">결재선 미리보기</div>
                            <div class="box-meta">검토/합의 병렬 · 최종결재 1명</div>
                        </div>

                        <div class="line-builder-actions">
                            <button type="button" id="btnAddReview">검토 추가</button>
                            <button type="button" id="btnAddAgreement">합의 추가</button>
                            <button type="button" id="btnAddFinal">최종결재 추가</button>
                            <button type="button" id="btnAddReference">참조 추가</button>
                            <button type="button" id="btnReset">전체 초기화</button>
                        </div>

                        <!-- 4칸 -->
                        <div class="line-builder-grid">
                            <div class="lane">
                                <div class="lane-head">1단계 · 검토</div>
                                <div id="reviewBox" class="lane-body"></div>
                            </div>

                            <div class="lane">
                                <div class="lane-head">2단계 · 합의</div>
                                <div id="agreementBox" class="lane-body"></div>
                            </div>

                            <div class="lane">
                                <div class="lane-head">3단계 · 최종결재</div>
                                <div id="finalBox" class="lane-body"></div>
                            </div>

                            <div class="lane">
                                <div class="lane-head">참조</div>
                                <div id="referenceBox" class="lane-body"></div>
                            </div>
                        </div>

                        <!-- JS가 submit용 hidden input 생성 -->
                        <div id="hiddenContainer"></div>

                        <div class="hint">

                        </div>
                    </div>

                </div>

                <!-- =========================
                     버튼 영역
                     ========================= -->
                <div class="btns">
                    <button type="button" class="btn" onclick="history.back()">취소</button>

                    <button type="submit" class="btn"
                            formaction="/approval/save">
                        임시저장
                    </button>

                    <button type="submit" class="btn primary"
                            formaction="/approval/submit"
                            onclick="return confirm('결재 요청(상신)하시겠습니까?');">
                        상신
                    </button>
                </div>

            </form>
        </div>
    </div>

</th:block>

<th:block layout:fragment="script">
    <script th:src="@{/js/Approval.js}"></script>
</th:block>

</body>
</html>
