<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
    <meta charset="UTF-8">
    <title>결재 문서 작성</title>

    <th:block layout:fragment="head">
        <link rel="stylesheet" th:href="@{/css/approve.css}">
    </th:block>
</head>

<body>
<th:block layout:fragment="content">

    <div class="approval-scope">
        <div class="wrap approval-create">

            <div class="page-head">
                <div class="page-actions">

                </div>
            </div>

            <form class="card form-card"
                  method="post"
                  th:action="@{/approval/submit}"
                  enctype="multipart/form-data">

                <div class="card-head">
                    <h3>문서 작성</h3>
                    <p class="meta">문서 유형 / 제목 / 내용 / 첨부</p>
                </div>

                <div class="rows">

                    <!-- 문서 유형 -->
                    <div class="row">
                        <label class="label">문서 유형</label>
                        <select class="control" name="typeId" required>
                            <option value="">문서 유형 선택</option>
                            <option th:each="t : ${types}"
                                    th:value="${t.typeId}"
                                    th:text="${t.typeName}">
                                유형
                            </option>
                        </select>
                    </div>

                    <!-- 제목 -->
                    <div class="row">
                        <label class="label">제목</label>
                        <input class="control" type="text" name="title" placeholder="제목을 입력하십시오" required>
                    </div>

                    <!-- 내용 -->
                    <div class="row row-content">
                        <label class="label">내용</label>
                        <textarea class="control textarea" name="content" rows="10" placeholder="내용을 입력하십시오" required></textarea>
                    </div>

                    <!-- 첨부 -->
                    <div class="row">
                        <label class="label">첨부 파일</label>
                        <input class="control" type="file" id="fileInput" name="files" multiple onchange="handleFileSelection(this)">
                        <div class="hint"></div>

                        <div id="fileListContainer">
                            <p class="placeholder">선택된 파일이 없습니다.</p>
                        </div>
                    </div>

                </div>

                <!-- =========================
                     결재선 구성 영역 (후보 + 4칸)
                     ========================= -->
                <div class="divider"></div>

                <div class="card-head">

                    <p class="meta">후보 체크 → 버튼(검토/합의/최종결재/참조)으로 배치</p>
                </div>

                <div class="approver-layout">

                    <!-- 후보 리스트 -->
                    <div class="approver-box">
                        <div class="box-head">
                            <div class="box-title">사용자 후보</div>
                            <div class="box-meta">ACTIVE 사용자</div>
                        </div>

                        <div class="candidate-list">
                            <label class="candidate" th:each="u : ${approvers}">
                                <input type="checkbox" class="candCheck"
                                       th:value="${u.userId}"
                                       th:data-name="${u.username}"
                                       th:data-dept="${u.deptName}"
                                       th:data-rank="${u.rankName}">
                                <span class="cand-name" th:text="${u.username}">이름</span>
                                <span class="cand-meta">
                                  (<span th:text="${u.deptName}">부서</span>
                                  <span th:if="${u.rankName != null}" th:text="' / ' + ${u.rankName}">/ 직급</span>)
                                </span>
                            </label>
                        </div>

                        <div class="hint">

                            최종결재는 1명만 가능합니다.
                        </div>
                    </div>

                    <!-- 구성/미리보기 -->
                    <div class="approver-box">
                        <div class="box-head">
                            <div class="box-title">결재선 미리보기</div>
                            <div class="box-meta">검토/합의 병렬 · 최종결재 1명</div>
                        </div>

                        <div class="line-builder-actions">
                            <button type="button" id="btnAddReview">검토 추가</button>
                            <button type="button" id="btnAddAgreement">합의 추가</button>
                            <button type="button" id="btnAddFinal">최종결재 추가</button>
                            <button type="button" id="btnAddReference">참조 추가</button>
                            <button type="button" id="btnReset">전체 초기화</button>
                        </div>

                        <!-- 4칸 -->
                        <div class="line-builder-grid">
                            <div class="lane">
                                <div class="lane-head">1단계 · 검토</div>
                                <div id="reviewBox" class="lane-body"></div>
                            </div>

                            <div class="lane">
                                <div class="lane-head">2단계 · 합의</div>
                                <div id="agreementBox" class="lane-body"></div>
                            </div>

                            <div class="lane">
                                <div class="lane-head">3단계 · 최종결재</div>
                                <div id="finalBox" class="lane-body"></div>
                            </div>

                            <div class="lane">
                                <div class="lane-head">참조</div>
                                <div id="referenceBox" class="lane-body"></div>
                            </div>
                        </div>

                        <!-- JS가 submit용 hidden input 생성 -->
                        <div id="hiddenContainer"></div>

                        <div class="hint">

                        </div>
                    </div>

                </div>

                <!-- =========================
                     버튼 영역
                     ========================= -->
                <div class="btns">
                    <button type="button" class="btn" onclick="history.back()">취소</button>

                    <button type="submit" class="btn"
                            formaction="/approval/save">
                        임시저장
                    </button>

                    <button type="submit" class="btn primary"
                            formaction="/approval/submit"
                            onclick="return confirm('결재 요청(상신)하시겠습니까?');">
                        상신
                    </button>
                </div>

            </form>
        </div>
    </div>

</th:block>

<th:block layout:fragment="script">
    <script th:src="@{/js/Approval.js}"></script>
</th:block>

</body>
</html>
