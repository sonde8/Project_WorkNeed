<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
    <title th:text="${pageTitle}"> 메인 </title>

    <!-- 페이지 전용 CSS -->
    <th:block layout:fragment="head">8
        <link rel="stylesheet" th:href="@{/css/main.css}">
        <link rel="stylesheet" th:href="@{/css/attendanceLeft.css}">
        <link rel="stylesheet" th:href="@{/css/main-kanban.css}">
        <link rel="stylesheet" th:href="@{/css/main-board.css}">

        <!-- 미니캘린더 -->
        <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet"/>
        <link rel="stylesheet" th:href="@{/css/mini-calendar.css}">

        <!-- 회의실 -->
        <link rel="stylesheet" th:href="@{/css/meetingroom.css}">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    </th:block>
    <!-- 로그인 정보 JS 주입 -->
    <script th:inline="javascript">
        window.LOGIN_USER_ID = /*[[${session.user != null ? session.user.userId : null}]]*/ null;
        window.IS_ADMIN = /*[[${session.admin != null}]]*/ false;
    </script>
</head>

<body>

<div layout:fragment="content" class = "pageMain">

    <div class="mainPage">

        <!-- 왼쪽 -->
        <section class = "leftPage">

            <!-- 오늘 날짜 -->
            <div class = "toDay" id="todayStart"
                 th:text="${today != null ? today : '날짜'}"> 날짜 </div>

            <!-- 프로필 -->
            <div class = "profile-card">

                <div class="profileImg">
                    <img th:if="${session.user.userProfileImage != null}"
                         th:src="${session.user.userProfileImage}"
                         alt="프로필 이미지">

                    <img th:unless="${session.user.userProfileImage != null}"
                         th:src="@{/images/default-profile.svg}"
                         alt="기본프로필"
                         class="profile">
                </div>

                <div class="profileText">
                    <div class="name" th:text="${user.userName}">사용자명</div>

                    <div class="profileMeta">
                        <span class="dept" th:text="${user.deptName}">부서명</span>
                        <span class="bar">|</span>
                        <span class="rank" th:text="${user.rankName}">직급</span>
                    </div>
                </div>

            </div>

            <!-- 출 퇴근 -->
            <div class = "attendWidget">
                <section th:replace="~{Attendance/attendanceLeft :: attendanceLeft}"></section>
            </div>

            <!-- 결제 -->
            <div class="main-kpi-approval">
                <a class="kpi" th:href="@{/approval/inbox/waiting}">
                    <span class="kpi-num" th:text="${counts.approverTodoCount}">0</span>  <!-- 여기 -->
                    <span class="kpi-label">대기</span>
                </a>

                <a class="kpi" th:href="@{/approval/inbox/done}">
                    <span class="kpi-num" th:text="${counts.approverDoneCount}">0</span>
                    <span class="kpi-label">완료</span>
                </a>

                <a class="kpi" th:href="@{/approval/my/drafts}">
                    <span class="kpi-num" th:text="${counts.drafterDraftCount}">0</span>
                    <span class="kpi-label">임시</span>
                </a>

                <a class="kpi" th:href="@{/approval/my/in-progress}">
                    <span class="kpi-num" th:text="${counts.drafterInProgressCount}">0</span>
                    <span class="kpi-label">진행</span>
                </a>

                <a class="kpi" th:href="@{/approval/my/approved}">
                    <span class="kpi-num" th:text="${counts.drafterApprovedCount}">0</span>
                    <span class="kpi-label">승인</span>
                </a>

                <a class="kpi kpi--danger" th:href="@{/approval/my/rejected}">
                    <span class="kpi-num" th:text="${counts.drafterRejectedCount}">0</span>
                    <span class="kpi-label">반려</span>
                </a>
            </div>
        </section>

        <!-- 오른쪽-->
        <section class = "rightPage">
            <!--게시판           -->
            <div class="main-borad">
                <div class="mini-borad">
                    <div class="mb-header">
                        <h3 class="mb-head">게시판</h3>
                        <button class="mb-write-btn" id="boardWriteBtn">+ 작성</button>
                    </div>

                    <ul class="mb-list" id="boardList">
                        <!-- JS로 게시글 렌더링 -->
                    </ul>
                </div>

                <!-- 게시글 모달 -->
                <div class="board-modal" id="boardDetailModal" style="display:none;">
                    <div class="board-modal-panel">
                        <div class="board-modal-header">
                            <h4 id="detailTitle"></h4>
                            <button class="modal-close" data-close="detail">×</button>
                        </div>
                        <div class="modal-meta">
                            <span id="detailWriter"></span>
                            <span id="detailDate"></span>
                        </div>
                        <div class="board-modal-content" id="detailContent"></div>
                        <button type="button" id="detailDeleteBtn" style="display:none;">삭제</button>
                    </div>
                </div>

                <!-- 게시글 작성 모달 -->
                <div class="board-modal" id="boardWriteModal" style="display:none;">
                    <div class="board-modal-panel">
                        <div class="board-modal-header">
                            <h4>게시글 작성</h4>
                            <button class="modal-close" data-close="write">×</button>
                        </div>

                        <div class="modal-sheet">
                            <select id="writeCategory"><!-- 카테고리 JS 로딩 --> </select>

                            <input type="text" id="writeTitle" placeholder="Title">

                            <textarea id="writeContent" placeholder="Content"></textarea>
                        </div>
                        <div class="modal-actions">
                            <button id="writeSubmitBtn">등록</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 미니캘린더 -->
            <div class="mini-calendar">
                <div id="miniCalendar" class="mini-calendar-wrapper"></div>
                <div id="miniCalendarTooltip"></div>
            </div>


            <div class="mini-kanban">
                <div th:replace="~{Main/main-kanban :: miniKanban}"></div>
            </div>

            <!-- 회의실 -->
            <div class="mini-meetingroom">

                <input type="hidden" id="currentUserId" th:value="${user.userId}">

                <div class="meetingroom-header">
                    <h3>회의실 예약</h3>
                    <div class="header-filters">
                        <div class="picker-wrapper">
                            <input type="text" id="statusDatePicker" class="picker-input date-picker">
                        </div>
                        <div class="picker-wrapper">
                            <input type="text" id="statusTimePicker" class="picker-input time-picker">
                        </div>
                    </div>
                </div>

                <div id="meeting-room-list" class="room-list-container">
                </div>
            </div>
        </section>
    </div>

    <div id="reservationModal" class="modal hidden">
        <div class="modal-content">
            <h3>회의실 예약</h3>
            <form id="reservationForm">
                <label>업무 (선택사항)</label>
                <select id="scheduleSelect" name="scheduleId">
                    <option value="">업무 선택 안 함</option>
                </select>

                <label>회의실</label>
                <select id="roomSelect" name="roomId" required></select>

                <label>날짜</label>
                <input type="text" id="reserveDate" name="date" required readonly>

                <label>시작 시간</label>
                <input type="text" id="startTime" name="startTime" required readonly>

                <label>종료 시간</label>
                <input type="text" id="endTime" name="endTime" required readonly>

                <div class="modal-actions">
                    <button type="submit">예약</button>
                    <button type="button" id="closeModalBtn">취소</button>
                </div>
            </form>
        </div>
    </div>


</div>
<th:block layout:fragment="script">
    <script th:src="@{/js/main.js}"></script>
    <script th:src="@{/js/attendanceLeft.js}"></script>

    <script th:inline="javascript">
        // 서버(Controller)에서 보낸 googleCalendarApiKey 값을 여기에 주입합니다.
        window.GOOGLE_CALENDAR_API_KEY = /*[[${googleCalendarApiKey}]]*/ '';
    </script>

    <script th:src="@{/js/board.js}"></script>

    <!-- 미니캘린더 -->
    <script th:src="@{/js/mini-calendar.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.11/index.global.min.js"></script>

    <!-- 회의실 -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script th:src="@{/js/meetingroom-status.js}"></script>
    <script th:src="@{/js/meetingroom-reservation.js}"></script>
</th:block>
</body>
</html>